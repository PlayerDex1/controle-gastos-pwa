import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc,
  doc, 
  onSnapshot, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  Plus, 
  ShoppingCart, 
  Droplet, 
  Zap, 
  Wifi, 
  Home as HomeIcon, 
  Trash2, 
  LogOut,
  Users,
  ChevronDown,
  ChevronUp,
  Receipt,
  Save,
  ClipboardPaste,
  X,
  Camera,
  Loader2,
  Sparkles,
  ChefHat,
  BrainCircuit,
  Wand2,
  Mic
} from 'lucide-react';

// --- Configura√ß√£o do Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- API do Gemini ---
const callGemini = async (prompt, jsonMode = false) => {
  const apiKey = ""; // A chave √© injetada automaticamente pelo ambiente
  try {
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: jsonMode ? { responseMimeType: "application/json" } : undefined
    };

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }
    );
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
  } catch (error) {
    console.error("Erro Gemini:", error);
    return null;
  }
};

// --- Componente Principal ---
export default function App() {
  const [user, setUser] = useState(null);
  const [familyId, setFamilyId] = useState(localStorage.getItem('familyId') || '');
  const [view, setView] = useState('onboarding'); 
  const [expenses, setExpenses] = useState([]);
  const [loading, setLoading] = useState(true);

  // Estado para Modais de IA (Dicas/Receitas)
  const [aiModalOpen, setAiModalOpen] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiContent, setAiContent] = useState('');
  const [aiTitle, setAiTitle] = useState('');

  // Autentica√ß√£o
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u && familyId) {
        setView('dashboard');
      } else {
        setLoading(false);
      }
    });
    return () => unsubscribe();
  }, [familyId]);

  // Carregar Dados
  useEffect(() => {
    if (!user || !familyId) return;

    const q = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const loaded = snapshot.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(item => item.familyId === familyId)
        .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      
      setExpenses(loaded);
      setLoading(false);
    }, (error) => {
      console.error("Erro ao ler dados:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user, familyId]);

  const handleJoinFamily = (id) => {
    if (!id.trim()) return;
    const cleanId = id.trim().toUpperCase();
    localStorage.setItem('familyId', cleanId);
    setFamilyId(cleanId);
    setView('dashboard');
  };

  const handleLogout = () => {
    localStorage.removeItem('familyId');
    setFamilyId('');
    setView('onboarding');
  };

  const handleDelete = async (id) => {
    if (window.confirm('Tem certeza que deseja apagar este registro?')) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
      } catch (e) {
        alert('Erro ao apagar');
      }
    }
  };

  // --- Fun√ß√µes de IA (Consultor e Chef) ---
  const handleAnalyzeFinances = async () => {
    setAiTitle("Consultor Financeiro IA");
    setAiLoading(true);
    setAiModalOpen(true);
    
    const summary = expenses.map(e => `${e.category}: R$ ${e.amount}`).join(', ');
    const total = expenses.reduce((acc, cur) => acc + Number(cur.amount), 0);
    
    const prompt = `
      Atue como um consultor financeiro pessoal amig√°vel.
      Analise estes gastos mensais: ${summary}. Total: R$ ${total}.
      1. Breve coment√°rio sobre a sa√∫de financeira.
      2. Categoria que mais pesa (exceto Aluguel).
      3. UMA dica pr√°tica de economia.
      Use emojis e portugu√™s do Brasil.
    `;

    const response = await callGemini(prompt);
    setAiContent(response || "N√£o foi poss√≠vel analisar no momento.");
    setAiLoading(false);
  };

  const handleSuggestRecipe = async (items) => {
    setAiTitle("Chef Inteligente");
    setAiLoading(true);
    setAiModalOpen(true);

    const itemList = items.map(i => i.name).join(', ');
    const prompt = `
      Lista de mercado: ${itemList}.
      Sugira UMA receita saborosa usando principalmente estes ingredientes.
      Formato:
      üçΩÔ∏è **[Nome do Prato]**
      ‚è±Ô∏è Tempo: [Tempo]
      üìù **Ingredientes:** [Lista]
      üç≥ **Preparo:** [Resumo]
    `;

    const response = await callGemini(prompt);
    setAiContent(response || "N√£o consegui criar uma receita agora.");
    setAiLoading(false);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (view === 'onboarding') {
    return <Onboarding onJoin={handleJoinFamily} />;
  }

  return (
    <div className="min-h-screen bg-gray-900 pb-20 font-sans text-gray-100 selection:bg-blue-500 selection:text-white">
      {/* Cabe√ßalho */}
      <header className="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-10 shadow-lg">
        <div className="flex justify-between items-center max-w-md mx-auto">
          <div>
            <h1 className="font-bold text-lg text-blue-400">Finan√ßas de Casa</h1>
            <p className="text-xs text-gray-400 flex items-center gap-1">
              <Users size={12} /> Fam√≠lia: <span className="font-mono text-gray-300">{familyId}</span>
            </p>
          </div>
          <button onClick={handleLogout} className="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition">
            <LogOut size={20} />
          </button>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4">
        {view === 'dashboard' && (
          <Dashboard 
            expenses={expenses} 
            onDelete={handleDelete} 
            onAnalyze={handleAnalyzeFinances}
            onSuggestRecipe={handleSuggestRecipe}
          />
        )}
        {view === 'add' && (
          <AddExpense 
            familyId={familyId} 
            onCancel={() => setView('dashboard')} 
            onSave={() => setView('dashboard')}
          />
        )}
      </main>

      {/* Navega√ß√£o */}
      {view === 'dashboard' && (
        <div className="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 pb-safe">
           <div className="max-w-md mx-auto flex justify-center">
             <button 
                onClick={() => setView('add')}
                className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-blue-500 transition transform active:scale-95 font-semibold"
             >
               <Plus size={24} />
               Nova Despesa
             </button>
           </div>
        </div>
      )}

      {/* Modal Gen√©rico de IA */}
      {aiModalOpen && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-in fade-in duration-200">
          <div className="bg-gray-800 w-full max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[85vh]">
            <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50 rounded-t-2xl">
              <h3 className="font-bold text-blue-400 flex items-center gap-2">
                <Sparkles size={18} />
                {aiTitle}
              </h3>
              <button onClick={() => setAiModalOpen(false)} className="p-1 hover:bg-gray-700 rounded-full">
                <X className="text-gray-400" size={20} />
              </button>
            </div>
            
            <div className="p-6 overflow-y-auto custom-scrollbar">
              {aiLoading ? (
                <div className="flex flex-col items-center justify-center py-8 space-y-4">
                  <div className="relative">
                    <div className="absolute inset-0 bg-blue-500 blur-xl opacity-20 animate-pulse"></div>
                    <BrainCircuit className="text-blue-400 animate-pulse relative z-10" size={48} />
                  </div>
                  <p className="text-sm text-gray-400 animate-pulse">O Gemini est√° analisando...</p>
                </div>
              ) : (
                <div className="prose prose-invert prose-sm max-w-none">
                  <div className="whitespace-pre-wrap font-light leading-relaxed text-gray-200">
                    {aiContent}
                  </div>
                </div>
              )}
            </div>
            
            {!aiLoading && (
              <div className="p-4 border-t border-gray-700 bg-gray-800/50">
                <button 
                  onClick={() => setAiModalOpen(false)}
                  className="w-full bg-gray-700 text-white py-3 rounded-xl font-medium hover:bg-gray-600 transition"
                >
                  Fechar
                </button>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// --- Componentes Auxiliares ---

function Onboarding({ onJoin }) {
  const [input, setInput] = useState('');

  return (
    <div className="min-h-screen bg-gray-900 flex items-center justify-center p-6">
      <div className="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
        <div className="bg-gray-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-gray-600">
          <HomeIcon className="text-blue-400" size={32} />
        </div>
        <h1 className="text-2xl font-bold text-white mb-2">Bem-vindo!</h1>
        <p className="text-gray-400 mb-6 text-sm">
          Use a mesma "Senha da Fam√≠lia" nos dois celulares para sincronizar.
        </p>
        
        <div className="space-y-4">
          <div className="text-left">
            <label className="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Nome da Fam√≠lia</label>
            <input 
              type="text" 
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="EX: SILVA2024"
              className="w-full p-3 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 outline-none uppercase text-center tracking-widest font-bold placeholder-gray-500"
            />
          </div>
          <button 
            onClick={() => onJoin(input)}
            disabled={!input}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold shadow-lg hover:bg-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Acessar App
          </button>
        </div>
      </div>
    </div>
  );
}

function Dashboard({ expenses, onDelete, onAnalyze, onSuggestRecipe }) {
  const total = useMemo(() => expenses.reduce((acc, cur) => acc + Number(cur.amount), 0), [expenses]);
  const formatMoney = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

  return (
    <div className="space-y-6 pb-20">
      <div className="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700 relative overflow-hidden">
        <div className="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-bl-full -mr-4 -mt-4"></div>
        <div className="flex justify-between items-start relative z-10">
          <div>
            <p className="text-gray-400 text-sm font-medium">Total Acumulado</p>
            <h2 className="text-4xl font-bold text-white mt-1">{formatMoney(total)}</h2>
          </div>
          {expenses.length > 0 && (
            <button 
              onClick={onAnalyze}
              className="flex flex-col items-center justify-center bg-blue-600/20 hover:bg-blue-600/30 border border-blue-500/30 text-blue-300 p-2 rounded-xl transition active:scale-95"
              title="Analisar com IA"
            >
              <Sparkles size={20} />
              <span className="text-[10px] font-bold mt-1">Dicas IA</span>
            </button>
          )}
        </div>
      </div>

      <div>
        <h3 className="font-semibold text-gray-400 mb-3 ml-1 text-sm uppercase tracking-wider">Hist√≥rico</h3>
        
        {expenses.length === 0 ? (
          <div className="text-center py-12 bg-gray-800/50 rounded-xl border border-dashed border-gray-700 text-gray-500">
            <Receipt className="mx-auto mb-3 opacity-50" size={40} />
            <p>Nenhuma conta lan√ßada ainda.</p>
          </div>
        ) : (
          <div className="space-y-3">
            {expenses.map(expense => (
              <ExpenseCard 
                key={expense.id} 
                expense={expense} 
                onDelete={onDelete}
                onSuggestRecipe={onSuggestRecipe}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function ExpenseCard({ expense, onDelete, onSuggestRecipe }) {
  const [isOpen, setIsOpen] = useState(false);
  const formatMoney = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

  const getIcon = (cat) => {
    switch(cat) {
      case 'Mercado': return <ShoppingCart size={20} />;
      case 'Aluguel': return <HomeIcon size={20} />;
      case 'Energia': return <Zap size={20} />;
      case '√Ågua': return <Droplet size={20} />;
      case 'Internet': return <Wifi size={20} />;
      default: return <Receipt size={20} />;
    }
  };

  const getColorClasses = (cat) => {
    switch(cat) {
      case 'Mercado': return 'bg-emerald-500/20 text-emerald-400';
      case 'Aluguel': return 'bg-purple-500/20 text-purple-400';
      case 'Energia': return 'bg-yellow-500/20 text-yellow-400';
      case '√Ågua': return 'bg-cyan-500/20 text-cyan-400';
      default: return 'bg-gray-700 text-gray-300';
    }
  };

  return (
    <div className="bg-gray-800 rounded-xl shadow-md border border-gray-700 overflow-hidden transition-all">
      <div 
        className="p-4 flex items-center justify-between cursor-pointer active:bg-gray-700/50"
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${getColorClasses(expense.category)}`}>
            {getIcon(expense.category)}
          </div>
          <div>
            <p className="font-semibold text-gray-200">{expense.category}</p>
            <p className="text-xs text-gray-500">{expense.description || 'Sem descri√ß√£o'}</p>
          </div>
        </div>
        <div className="text-right">
          <p className="font-bold text-gray-200">{formatMoney(expense.amount)}</p>
          <div className="flex justify-end mt-1">
            {isOpen ? <ChevronUp size={16} className="text-gray-500"/> : <ChevronDown size={16} className="text-gray-500"/>}
          </div>
        </div>
      </div>

      {isOpen && (
        <div className="bg-gray-900/30 px-4 py-3 border-t border-gray-700 animate-in slide-in-from-top-2 duration-200">
          {expense.items && expense.items.length > 0 && (
            <div className="mb-4">
              <div className="flex justify-between items-center mb-2">
                <p className="text-xs font-bold text-gray-500 uppercase tracking-wider">Lista de Compras</p>
                {expense.category === 'Mercado' && (
                  <button 
                    onClick={(e) => { e.stopPropagation(); onSuggestRecipe(expense.items); }}
                    className="flex items-center gap-1 text-[10px] bg-emerald-900/30 text-emerald-400 border border-emerald-800/50 px-2 py-1 rounded hover:bg-emerald-900/50 transition"
                  >
                    <ChefHat size={12} />
                    Receita com IA
                  </button>
                )}
              </div>
              <ul className="space-y-1">
                {expense.items.map((item, idx) => (
                  <li key={idx} className="flex justify-between text-sm text-gray-400 border-b border-gray-700 pb-1 last:border-0">
                    <span>{item.name}</span>
                    <span>{formatMoney(item.price)}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          <div className="flex justify-between items-center text-xs text-gray-500 mt-2">
            <span>{new Date(expense.createdAt?.seconds * 1000).toLocaleDateString('pt-BR')}</span>
            <button 
              onClick={(e) => { e.stopPropagation(); onDelete(expense.id); }}
              className="text-red-400 hover:text-red-300 flex items-center gap-1 px-2 py-1 rounded hover:bg-red-500/10 transition"
            >
              <Trash2 size={14} /> Apagar
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// --- Adicionar (Completo: OCR + Magic + Manual) ---
function AddExpense({ familyId, onCancel, onSave }) {
  const [category, setCategory] = useState('Mercado');
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  
  const [items, setItems] = useState([]);
  const [newItemName, setNewItemName] = useState('');
  const [newItemPrice, setNewItemPrice] = useState('');
  
  // OCR & Importa√ß√£o
  const [showImport, setShowImport] = useState(false);
  const [importText, setImportText] = useState('');
  const [isProcessingImg, setIsProcessingImg] = useState(false);
  const fileInputRef = useRef(null);
  
  // Entrada M√°gica
  const [showMagic, setShowMagic] = useState(false);
  const [magicText, setMagicText] = useState('');
  const [magicLoading, setMagicLoading] = useState(false);

  const categories = ['Mercado', 'Aluguel', 'Energia', '√Ågua', 'Internet', 'Outros'];

  // Carregar Tesseract dinamicamente
  useEffect(() => {
    if (!window.Tesseract && showImport) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
      script.async = true;
      document.body.appendChild(script);
    }
  }, [showImport]);

  const handleAddItem = () => {
    if (!newItemName || !newItemPrice) return;
    const price = parseFloat(newItemPrice.replace(',', '.'));
    if (isNaN(price)) return;
    setItems([...items, { name: newItemName, price }]);
    setNewItemName('');
    setNewItemPrice('');
  };

  // --- Processamento de Texto Inteligente (Com ou Sem IA) ---
  const processTextSmart = async (text) => {
    // 1. Tentar limpar com Gemini primeiro (muito mais preciso)
    const prompt = `
      Analise este texto cru de OCR de uma nota fiscal ou lista:
      """${text}"""
      
      Extraia apenas os itens de produto e seus pre√ßos.
      Ignore subtotais, datas, CNPJ, endere√ßos e "troco".
      Retorne APENAS um JSON v√°lido neste formato (sem markdown):
      [{"name": "nome do item", "price": 10.50}, ...]
    `;
    
    try {
      const jsonStr = await callGemini(prompt, true);
      if (jsonStr) {
        const cleaned = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
        const parsed = JSON.parse(cleaned);
        if (Array.isArray(parsed) && parsed.length > 0) {
          return parsed;
        }
      }
    } catch (e) {
      console.warn("Falha no Gemini OCR, usando Regex de fallback", e);
    }

    // 2. Fallback para Regex (se IA falhar)
    const lines = text.split('\n');
    const foundItems = [];
    const priceRegex = /(.+?)\s+(?:R\$\s?|Vl\.?\s?Total\s?)?(\d{1,3}(?:\.\d{3})*,\d{2})/;

    lines.forEach(line => {
      const cleanLine = line.trim();
      if (!cleanLine) return;
      if (cleanLine.match(/CNPJ|CPF|Imposto|Tributo|Troco|Dinheiro|Cart√£o|Subtotal/i)) return;

      const match = cleanLine.match(priceRegex);
      if (match) {
        let name = match[1].trim().replace(/^[\d\s\.\-]+/, '');
        const price = parseFloat(match[2].replace('.', '').replace(',', '.'));

        if (name.length > 2 && !isNaN(price) && price > 0) {
           if (!name.toLowerCase().includes('total') && !name.toLowerCase().includes('pagar')) {
             foundItems.push({ name: name.substring(0, 20), price });
           }
        }
      }
    });
    return foundItems;
  };

  const handleTextImport = async () => {
    setIsProcessingImg(true);
    const found = await processTextSmart(importText);
    setIsProcessingImg(false);
    
    if (found.length > 0) {
      setItems([...items, ...found]);
      setImportText('');
      setShowImport(false);
      alert(`${found.length} itens encontrados!`);
    } else {
      alert("N√£o consegui identificar itens. Tente melhorar o texto.");
    }
  };

  const handleImageUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!window.Tesseract) {
      alert("Aguarde, carregando leitor...");
      return;
    }

    setIsProcessingImg(true);
    try {
      const { createWorker } = window.Tesseract;
      const worker = await createWorker('por');
      const { data: { text } } = await worker.recognize(file);
      await worker.terminate();

      // Envia o texto sujo para o Gemini limpar
      const found = await processTextSmart(text);
      
      if (found.length > 0) {
        setItems([...items, ...found]);
        setShowImport(false);
        alert(`${found.length} itens lidos e processados pela IA!`);
      } else {
        alert("O texto foi lido, mas a IA n√£o achou produtos claros.");
        setImportText(text); // Deixa o usu√°rio ver o que rolou
      }
    } catch (err) {
      console.error(err);
      alert("Erro ao processar imagem.");
    } finally {
      setIsProcessingImg(false);
    }
  };

  // --- Entrada M√°gica (Magic Entry) ---
  const handleMagicFill = async () => {
    if (!magicText.trim()) return;
    setMagicLoading(true);

    const prompt = `
      Interprete este comando de despesa em texto natural: "${magicText}".
      Categorias permitidas: ${categories.join(', ')}.
      Retorne um JSON puro (sem markdown) neste formato:
      {
        "category": "Uma das categorias acima",
        "amount": 0.00 (n√∫mero),
        "description": "Descri√ß√£o curta baseada no texto"
      }
    `;

    try {
      const response = await callGemini(prompt, true);
      const cleaned = response.replace(/```json/g, '').replace(/```/g, '').trim();
      const data = JSON.parse(cleaned);

      if (data.category) setCategory(data.category);
      if (data.amount) setAmount(data.amount.toString());
      if (data.description) setDescription(data.description);
      
      setShowMagic(false);
      setMagicText('');
    } catch (e) {
      alert("N√£o entendi o comando. Tente algo como 'Internet 100 reais'.");
    } finally {
      setMagicLoading(false);
    }
  };

  // Totais e Submit
  const displayTotal = useMemo(() => {
    let total = 0;
    if (category === 'Mercado') {
      total = items.reduce((acc, item) => acc + item.price, 0);
    } else {
      total = parseFloat(amount.toString().replace(',', '.')) || 0;
    }
    return total;
  }, [category, items, amount]);

  const handleSubmit = async () => {
    let finalItems = [...items];
    let finalTotal = 0;

    if (category === 'Mercado') {
      if (newItemName && newItemPrice) {
        const pendingPrice = parseFloat(newItemPrice.replace(',', '.'));
        if (!isNaN(pendingPrice)) {
          finalItems.push({ name: newItemName, price: pendingPrice });
        }
      }
      if (finalItems.length === 0) {
        alert('Adicione itens ou use o bot√£o de Importar.');
        return;
      }
      finalTotal = finalItems.reduce((acc, item) => acc + item.price, 0);
    } else {
      finalTotal = parseFloat(amount.toString().replace(',', '.')) || 0;
    }

    if (finalTotal <= 0) {
      alert('O valor total deve ser maior que zero.');
      return;
    }

    const docData = {
      familyId,
      category,
      amount: finalTotal,
      description,
      items: category === 'Mercado' ? finalItems : [],
      createdAt: serverTimestamp(),
    };

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), docData);
      onSave();
    } catch (error) {
      console.error(error);
      alert('Erro ao salvar.');
    }
  };

  const formatMoney = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

  // --- Modais ---
  if (showImport) {
    return (
      <div className="fixed inset-0 bg-gray-900/95 z-50 flex items-center justify-center p-4">
        <div className="bg-gray-800 rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl flex flex-col max-h-[90vh]">
          <div className="p-4 border-b border-gray-700 flex justify-between items-center">
            <h3 className="font-bold text-white flex items-center gap-2">
              <Sparkles size={16} className="text-blue-400" /> 
              Importar Nota (IA)
            </h3>
            {!isProcessingImg && <button onClick={() => setShowImport(false)}><X className="text-gray-400" /></button>}
          </div>
          
          <div className="p-4 space-y-4 overflow-y-auto">
            <div className="bg-gray-700/50 p-4 rounded-xl border border-gray-600 text-center">
              <p className="text-sm text-gray-300 mb-3 font-medium">Foto da Nota</p>
              
              {isProcessingImg ? (
                <div className="flex flex-col items-center py-4 text-blue-400">
                  <Loader2 className="animate-spin mb-2" size={32} />
                  <p className="text-xs">Lendo e Processando com IA...</p>
                </div>
              ) : (
                <>
                  <input 
                    type="file" 
                    accept="image/*" 
                    capture="environment"
                    ref={fileInputRef}
                    className="hidden"
                    onChange={handleImageUpload}
                  />
                  <button 
                    onClick={() => fileInputRef.current?.click()}
                    className="bg-blue-600 text-white px-4 py-3 rounded-lg flex items-center justify-center gap-2 w-full font-bold hover:bg-blue-500 transition"
                  >
                    <Camera size={20} />
                    Tirar Foto
                  </button>
                </>
              )}
            </div>

            <div className="flex items-center gap-2 text-gray-500">
              <div className="h-px bg-gray-600 flex-1"></div>
              <span className="text-xs">OU</span>
              <div className="h-px bg-gray-600 flex-1"></div>
            </div>

            <div className="space-y-2">
              <p className="text-sm text-gray-300 font-medium">Colar Texto</p>
              <textarea 
                value={importText}
                onChange={e => setImportText(e.target.value)}
                className="w-full h-32 bg-gray-900 border border-gray-600 rounded-lg p-3 text-xs text-white font-mono focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="Cole o texto bagun√ßado aqui e a IA organiza..."
              />
              <button 
                onClick={handleTextImport}
                disabled={!importText || isProcessingImg}
                className="w-full bg-gray-700 text-white py-3 rounded-lg font-bold hover:bg-gray-600 transition border border-gray-600 disabled:opacity-50"
              >
                {isProcessingImg ? 'Processando...' : 'Processar com IA'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // UI Principal de Adicionar
  return (
    <div className="bg-gray-800 rounded-2xl shadow-lg overflow-hidden min-h-[80vh] relative flex flex-col border border-gray-700">
      <div className="bg-gray-700 p-4 flex justify-between items-center border-b border-gray-600">
        <button onClick={onCancel} className="text-gray-400 hover:text-white">Cancelar</button>
        <h2 className="font-bold text-white">Nova Despesa</h2>
        <div className="w-16"></div>
      </div>

      <div className="p-5 space-y-6 flex-1 overflow-y-auto pb-32">
        {/* Bot√£o de Entrada M√°gica */}
        {!showMagic ? (
          <button 
            onClick={() => setShowMagic(true)}
            className="w-full bg-gradient-to-r from-blue-900 to-purple-900 border border-blue-700/50 p-3 rounded-xl flex items-center justify-center gap-2 text-blue-200 hover:text-white transition group"
          >
            <Wand2 size={18} className="group-hover:animate-pulse" />
            <span className="font-medium">Preencher com IA</span>
          </button>
        ) : (
          <div className="bg-gray-900/50 border border-blue-500/30 p-3 rounded-xl space-y-2 animate-in fade-in slide-in-from-top-2">
            <div className="flex justify-between items-center">
              <label className="text-xs text-blue-400 font-bold flex items-center gap-1">
                <Sparkles size={12} /> Diga o que gastou:
              </label>
              <button onClick={() => setShowMagic(false)}><X size={14} class="text-gray-500"/></button>
            </div>
            <div className="flex gap-2">
              <input 
                autoFocus
                type="text" 
                value={magicText}
                onChange={e => setMagicText(e.target.value)}
                placeholder="Ex: Almo√ßo 45 reais"
                className="flex-1 bg-gray-800 border border-gray-600 rounded-lg p-2 text-sm text-white focus:border-blue-500 outline-none"
                onKeyDown={e => e.key === 'Enter' && handleMagicFill()}
              />
              <button 
                onClick={handleMagicFill}
                disabled={magicLoading || !magicText}
                className="bg-blue-600 px-3 rounded-lg text-white hover:bg-blue-500 disabled:opacity-50"
              >
                {magicLoading ? <Loader2 size={18} className="animate-spin" /> : <Wand2 size={18} />}
              </button>
            </div>
          </div>
        )}

        <div>
          <label className="block text-xs font-medium text-gray-500 mb-2 uppercase">Categoria</label>
          <div className="grid grid-cols-3 gap-2">
            {categories.map(cat => (
              <button
                key={cat}
                onClick={() => setCategory(cat)}
                className={`py-2 px-1 rounded-lg text-sm font-medium transition border ${
                  category === cat 
                    ? 'bg-blue-600 border-blue-500 text-white' 
                    : 'bg-gray-700 border-gray-600 text-gray-300 hover:bg-gray-600'
                }`}
              >
                {cat}
              </button>
            ))}
          </div>
        </div>

        {category === 'Mercado' ? (
          <div className="bg-gray-900/50 rounded-xl p-4 border border-gray-700 relative">
            <div className="flex justify-between items-center mb-3">
              <div className="flex items-center gap-2 text-emerald-400 font-semibold">
                <ShoppingCart size={18} />
                <h3>Carrinho</h3>
              </div>
              <button 
                onClick={() => setShowImport(true)}
                className="flex items-center gap-1 text-xs bg-emerald-900/50 text-emerald-400 px-3 py-1.5 rounded border border-emerald-800 hover:bg-emerald-900 transition font-medium shadow-sm"
              >
                <Camera size={14} />
                Escanear Nota (IA)
              </button>
            </div>
            
            <div className="flex gap-2 mb-3">
              <input 
                type="text" 
                placeholder="Item" 
                className="flex-1 p-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                value={newItemName}
                onChange={e => setNewItemName(e.target.value)}
              />
              <input 
                type="number" 
                placeholder="R$" 
                className="w-20 p-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500 outline-none"
                value={newItemPrice}
                onChange={e => setNewItemPrice(e.target.value)}
              />
              <button 
                onClick={handleAddItem}
                className="bg-emerald-600 text-white px-3 rounded-lg hover:bg-emerald-500 transition"
              >
                <Plus size={20} />
              </button>
            </div>

            <div className="space-y-1 max-h-48 overflow-y-auto pr-1 custom-scrollbar">
              {items.slice().reverse().map((item, idx) => (
                <div key={idx} className="flex justify-between text-sm bg-gray-800 p-2 rounded border border-gray-700 text-gray-300">
                  <span>{item.name}</span>
                  <div className="flex items-center gap-2">
                     <span className="font-mono text-emerald-400">{formatMoney(item.price)}</span>
                     <button 
                       onClick={() => setItems(items.filter((_, i) => i !== (items.length - 1 - idx)))}
                       className="text-gray-500 hover:text-red-400"
                     >
                       <X size={14} />
                     </button>
                  </div>
                </div>
              ))}
              {items.length === 0 && (
                <div className="text-center py-6">
                  <p className="text-xs text-gray-500 italic mb-2">
                    Adicione itens manualmente ou via Scan.
                  </p>
                </div>
              )}
            </div>
          </div>
        ) : (
          <div>
            <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Valor</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">R$</span>
              <input 
                type="number" 
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                className="w-full pl-10 p-4 bg-gray-900 border border-gray-700 rounded-xl text-white focus:ring-2 focus:ring-blue-500 outline-none text-xl font-bold placeholder-gray-600"
                placeholder="0,00"
              />
            </div>
          </div>
        )}

        <div>
          <label className="block text-xs font-medium text-gray-500 mb-1 uppercase">Detalhes (Opcional)</label>
          <input 
            type="text" 
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            placeholder="Ex: Supermercado do Bairro"
            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-500"
          />
        </div>
      </div>

      <div className="absolute bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-4">
         <div className="flex items-center justify-between">
           <div>
             <p className="text-xs text-gray-500 uppercase">Total Estimado</p>
             <p className="text-2xl font-bold text-blue-400">
               {formatMoney(category === 'Mercado' ? (displayTotal + (parseFloat(newItemPrice.replace(',','.')) || 0)) : displayTotal)}
             </p>
           </div>
           <button 
             onClick={handleSubmit}
             className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-500 transition flex items-center gap-2"
           >
             <Save size={20} /> Salvar
           </button>
         </div>
      </div>
    </div>
  );
}
